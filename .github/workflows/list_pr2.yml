name: List Merged PRs for Release

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  list-merged-prs:
    if: startsWith(github.head_ref, 'develop')
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: GitHub CLI ã®èªè¨¼
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: PRã‚’ãƒªã‚¹ãƒˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          headRef=${{ github.head_ref }}
          baseRef=${{ github.base_ref }}

          echo "ğŸ” Checking merged PRs included in $headRef -> $baseRef ..."

          # `develop` -> `main` ã® PR ã«å«ã¾ã‚Œã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          commits=$(git log --pretty=format:"%H" origin/$baseRef...origin/$headRef)

          # å–å¾—ã—ãŸã‚³ãƒŸãƒƒãƒˆã‚’å…ƒã« PR ã‚’ç‰¹å®š
          prs=()
          while read -r commit; do
            pr_info=$(gh pr list --state merged --json number,title,url,mergeCommit --limit 100 | jq -r --arg commit "$commit" '.[] | select(.mergeCommit == $commit) | "- [#" + (.number | tostring) + "](" + .url + ") " + .title')
            if [[ -n "$pr_info" ]]; then
              prs+=("$pr_info")
            fi
          done <<< "$commits"

          # PRãŒè¦‹ã¤ã‹ã£ãŸã‹ç¢ºèª
          if [[ ${#prs[@]} -eq 0 ]]; then
            echo "âš ï¸ No merged PRs found for this release branch."
            exit 0
          fi

          # PRãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
          echo "âœ… Merged PRs in this release:"
          printf "%s\n" "${prs[@]}"

          # Actionsã®å‡ºåŠ›ã«ã‚‚ä¿å­˜ï¼ˆä»–ã®ã‚¸ãƒ§ãƒ–ã§ä½¿ã†å ´åˆï¼‰
          echo "merged_prs<<EOF" >> $GITHUB_ENV
          printf "%s\n" "${prs[@]}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
